/*
 * Copyright (C) 2014 denkbares GmbH, Germany
 *
 * This is free software; you can redistribute it and/or modify it under the
 * terms of the GNU Lesser General Public License as published by the Free
 * Software Foundation; either version 3 of the License, or (at your option) any
 * later version.
 *
 * This software is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE. See the GNU Lesser General Public License for more
 * details.
 *
 * You should have received a copy of the GNU Lesser General Public License
 * along with this software; if not, write to the Free Software Foundation,
 * Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA, or see the FSF
 * site: http://www.fsf.org.
 */

(function (e, t) {
	"use strict";
	if (typeof define === "function" && define.amd) {
		define(t)
	} else {
		e.simpleStorage = t()
	}
})(this, function () {
	"use strict";
	function s() {
		window.localStorage.setItem("__simpleStorageInitTest", "tmpval");
		window.localStorage.removeItem("__simpleStorageInitTest");
		a();
		l();
		o();
		if ("addEventListener"in window) {
			window.addEventListener("pageshow", function (e) {
				if (e.persisted) {
					u()
				}
			}, false)
		}
		r = true
	}

	function o() {
		if ("addEventListener"in window) {
			window.addEventListener("storage", u, false)
		} else {
			document.attachEvent("onstorage", u)
		}
	}

	function u() {
		try {
			a()
		} catch (e) {
			r = false;
			return
		}
		l()
	}

	function a() {
		var e = localStorage.simpleStorage;
		try {
			t = JSON.parse(e)
		} catch (r) {
			t = {}
		}
		n = localStorage.simpleStorage ? String(localStorage.simpleStorage).length : 0
	}

	function f() {
		try {
			localStorage.simpleStorage = JSON.stringify(t);
			n = localStorage.simpleStorage ? String(localStorage.simpleStorage).length : 0
		} catch (e) {
			return e
		}
		return true
	}

	function l() {
		var e, n, r, s, o, u = Infinity, a = 0;
		clearTimeout(i);
		if (!t || !t.__simpleStorage_meta || !t.__simpleStorage_meta.TTL) {
			return
		}
		e = +(new Date);
		o = t.__simpleStorage_meta.TTL.keys || [];
		s = t.__simpleStorage_meta.TTL.expire || {};
		for (n = 0, r = o.length; n < r; n++) {
			if (s[o[n]] <= e) {
				a++;
				delete t[o[n]];
				delete s[o[n]]
			} else {
				if (s[o[n]] < u) {
					u = s[o[n]]
				}
				break
			}
		}
		if (u != Infinity) {
			i = setTimeout(l, u - e)
		}
		if (a) {
			o.splice(0, a);
			h();
			f()
		}
	}

	function c(e, n) {
		var r = +(new Date), s, o, u = false;
		n = Number(n) || 0;
		if (n !== 0) {
			if (t.hasOwnProperty(e)) {
				if (!t.__simpleStorage_meta) {
					t.__simpleStorage_meta = {}
				}
				if (!t.__simpleStorage_meta.TTL) {
					t.__simpleStorage_meta.TTL = {expire: {}, keys: []}
				}
				t.__simpleStorage_meta.TTL.expire[e] = r + n;
				if (t.__simpleStorage_meta.TTL.expire.hasOwnProperty(e)) {
					for (s = 0, o = t.__simpleStorage_meta.TTL.keys.length; s < o; s++) {
						if (t.__simpleStorage_meta.TTL.keys[s] == e) {
							t.__simpleStorage_meta.TTL.keys.splice(s)
						}
					}
				}
				for (s = 0, o = t.__simpleStorage_meta.TTL.keys.length; s < o; s++) {
					if (t.__simpleStorage_meta.TTL.expire[t.__simpleStorage_meta.TTL.keys[s]] > r + n) {
						t.__simpleStorage_meta.TTL.keys.splice(s, 0, e)
					}
				}
				if (!u) {
					t.__simpleStorage_meta.TTL.keys.push(e)
				}
			} else {
				return false
			}
		} else {
			if (t && t.__simpleStorage_meta && t.__simpleStorage_meta.TTL) {
				if (t.__simpleStorage_meta.TTL.expire.hasOwnProperty(e)) {
					delete t.__simpleStorage_meta.TTL.expire[e];
					for (s = 0, o = t.__simpleStorage_meta.TTL.keys.length; s < o; s++) {
						if (t.__simpleStorage_meta.TTL.keys[s] == e) {
							t.__simpleStorage_meta.TTL.keys.splice(s, 1);
							break
						}
					}
				}
				h()
			}
		}
		clearTimeout(i);
		if (t && t.__simpleStorage_meta && t.__simpleStorage_meta.TTL && t.__simpleStorage_meta.TTL.keys.length) {
			i = setTimeout(l, Math.max(t.__simpleStorage_meta.TTL.expire[t.__simpleStorage_meta.TTL.keys[0]] - r, 0))
		}
		return true
	}

	function h() {
		var e = false, n = false, r;
		if (!t || !t.__simpleStorage_meta) {
			return e
		}
		if (t.__simpleStorage_meta.TTL && !t.__simpleStorage_meta.TTL.keys.length) {
			delete t.__simpleStorage_meta.TTL;
			e = true
		}
		for (r in t.__simpleStorage_meta) {
			if (t.__simpleStorage_meta.hasOwnProperty(r)) {
				n = true;
				break
			}
		}
		if (!n) {
			delete t.__simpleStorage_meta;
			e = true
		}
		return e
	}

	var e = "0.1.2", t = false, n = 0, r = false, i = null;
	try {
		s()
	} catch (p) {
	}
	return{version: e, canUse: function () {
		return!!r
	}, set: function (e, n, r) {
		if (e == "__simpleStorage_meta") {
			return false
		}
		if (!t) {
			return false
		}
		if (typeof n == "undefined") {
			return this.deleteKey(e)
		}
		r = r || {};
		try {
			n = JSON.parse(JSON.stringify(n))
		} catch (i) {
			return i
		}
		t[e] = n;
		c(e, r.TTL || 0);
		return f()
	}, get: function (e) {
		if (!t) {
			return false
		}
		if (t.hasOwnProperty(e) && e != "__simpleStorage_meta") {
			if (this.getTTL(e)) {
				return t[e]
			}
		}
	}, deleteKey: function (e) {
		if (!t) {
			return false
		}
		if (e in t) {
			delete t[e];
			c(e, 0);
			return f()
		}
		return false
	}, setTTL: function (e, n) {
		if (!t) {
			return false
		}
		c(e, n);
		return f()
	}, getTTL: function (e) {
		var n;
		if (!t) {
			return false
		}
		if (t.hasOwnProperty(e)) {
			if (t.__simpleStorage_meta && t.__simpleStorage_meta.TTL && t.__simpleStorage_meta.TTL.expire && t.__simpleStorage_meta.TTL.expire.hasOwnProperty(e)) {
				n = Math.max(t.__simpleStorage_meta.TTL.expire[e] - +(new Date) || 0, 0);
				return n || false
			} else {
				return Infinity
			}
		}
		return false
	}, flush: function () {
		if (!t) {
			return false
		}
		t = {};
		try {
			localStorage.removeItem("simpleStorage");
			return true
		} catch (e) {
			return e
		}
	}, index: function () {
		if (!t) {
			return false
		}
		var e = [], n;
		for (n in t) {
			if (t.hasOwnProperty(n) && n != "__simpleStorage_meta") {
				e.push(n)
			}
		}
		return e
	}, storageSize: function () {
		return n
	}}
})